<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport"
  content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  <!-- runs in full-screen mode on iOS devices -->
  <meta name="apple-mobile-web-app-capable" content="yes">

  <title>WebGL Test</title>
  
  <!-- jQuery and LoDash are dependencies -->
  <script src="../../sherpa/jquery-2.0.3.min.js"></script>
  <script src="../../sherpa/lodash-2.0.0.min.js"></script>
  <script src="../../sherpa/has.js"></script>
  
  <!-- Our code, in either the concatenated 'with comments' version or the minified version -->
  <script data-main="../js/config.js" src="../../sherpa/require-2.1.8.js"></script>

  <script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;
    
    uniform vec4 color;
    varying vec2 vPosition; // not used yet

    void main( void ) {
      gl_FragColor = color;
    }
  </script>

  <script id="shader-vs" type="x-shader/x-vertex">
    precision mediump float;
    
    attribute vec2 aVertexPosition;
    varying vec2 vPosition;
    uniform mat3 uMatrix;

    void main( void ) {
      gl_Position = vec4( uMatrix * vec3( aVertexPosition, 1.0 ), 1.0 );

      vPosition = aVertexPosition;
    }
  </script>
  <style type="text/css">
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: #000;
      overflow: hidden;
    }

    canvas {
      position: absolute;
    }
  </style>
</head>

<body id="home">

<canvas id="main" width="1024" height="768" style="z-index:0;">
  Your browser appears to not support the HTML5 <code>&lt;canvas&gt;</code> element!
</canvas>

<script type="text/javascript">
  var canvas = document.getElementById( 'main' );
  
  var fragmentShaderSrc = document.getElementById( 'shader-fs' ).textContent;
  var vertexShaderSrc = document.getElementById( 'shader-vs' ).textContent;
  
  requirejs( [ 'main', '../../kite/js/main', '../../dot/js/main' ], function( scenery, kite, dot ) {
    window.scenery = scenery;
    window.kite = kite;
    window.dot = dot;
    
    var gl = scenery.GLUtil.getWebGLContext( canvas );
    
    var program = new scenery.GLShaderProgram( gl, [scenery.GLShader.fragmentShader( gl, fragmentShaderSrc ), scenery.GLShader.vertexShader( gl, vertexShaderSrc )],
                                               ['aVertexPosition'], ['uMatrix','color'] );
    
    var width = canvas.width;
    var height = canvas.height;
    
    var matrix = new dot.Matrix3( 2 / width, 0,         -1,
                                  0,        -2 / height, 1,
                                  0,         0,          1 );
    
    gl.viewport( 0, 0, width, height );
    gl.clearColor( 0, 1, 0, 1 );
    gl.clear( gl.COLOR_BUFFER_BIT );
    
    gl.disable( gl.DEPTH_TEST );
    gl.enable( gl.BLEND );
    gl.blendFunc( gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA );
    
    gl.uniform4f( program.color, 1, 0, 0, 1 );
    gl.uniformMatrix3fv( program.uMatrix, false, new Float32Array( matrix.entries ) );
    
    var positionBuffer = gl.createBuffer();
    gl.bindBuffer( gl.ARRAY_BUFFER, positionBuffer );
    gl.bufferData( gl.ARRAY_BUFFER, new Float32Array( [0,0,width/2,height,width/2,0] ), gl.STATIC_DRAW );
    
    gl.bindBuffer( gl.ARRAY_BUFFER, positionBuffer );
    gl.vertexAttribPointer( program.aVertexPosition, 2, gl.FLOAT, false, 0, 0 );
      
    gl.drawArrays( gl.TRIANGLES, 0, 3 );
  } );
</script>

</body>
</html>
