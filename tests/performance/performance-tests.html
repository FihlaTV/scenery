<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Performance Testing for phet-scene</title>
  
  <link rel="stylesheet" href="../../contrib/bootstrap-2.2.2.css">
  
  <script src="../../contrib/jquery-1.8.3.min.js"></script>
  <script src="../../contrib/lodash.min-1.0.0-rc.3.js"></script>
  <script src="../../contrib/benchmark-1.0.0.js"></script>
  <script src="../../contrib/bootstrap-2.2.2.js"></script>
  
  <!-- <script src="../../phet-scene-min.js"></script> -->
  <!-- <script src="js/marks.js"></script> -->
  
  <style>
    .table {
      width: auto !important;
    }
  </style>
</head>
<body>
  <div id="main" style="position: absolute; left: 0; top: 0; background-color: white; z-index: 0;">
  </div>
  <div id="profiling-results">
  </div>
  <script type="text/javascript">
    // $( window ).load( function() {
    //   window.benchmarkTimer = new marks.Timer( new marks.TableReport( $( '#profiling-results' )[0] ) );
      
    //   benchmarkTimer.compareSnapshots( [
    //     { name: 'current', libs: [ '../../phet-scene-min.js' ], tests: [ 'js/current.js' ] },
    //     { name: '120202-515bfa9d9a', libs: [ 'snapshots/phet-scene-min-120202-515bfa9d9a.js' ], tests: [ 'snapshots/tests-120202-515bfa9d9a.js' ] },
    //     { name: 'control', libs: [ '../../phet-scene-min.js' ], tests: [ 'js/current.js' ] }
    //   ] );
    // } );
    
    mainLoop();
    
    function mainLoop() {
      loadScript( '../../phet-scene-min.js', function() {
        testA( 20, function( msElapsed ) {
          console.log( 'a: ' + msElapsed );
          mainLoop();
        } );
      } );
    }
    
    function testA( maxCount, finished ) {
      var width = 1024;
      var height = 768;
      
      var main = $( '#main' );
      main.width( width );
      main.height( height );
      var scene = new phet.scene.Scene( main );
      for( var i = 0; i < 2000; i++ ) {
        scene.root.addChild( new phet.scene.Node( {
          shape: phet.scene.Shape.rectangle( ( Math.PI * i ) % width, ( 27 * i ) % height, 20, 20 ),
          fill: 'rgba(255,0,0,0.3)',
          stroke: '#000000'
        } ) );
      }
      
      var count = 0;
      
      function tick() {
        if( count++ === maxCount ) {
          finished( new Date - startTime );
        } else {
          window.requestAnimationFrame( tick, main[0] );
          
          scene.root.rotateAround( new phet.math.Vector2( width / 2, height / 2 ), 0.01 );
          scene.updateScene();
        }
      }
      window.requestAnimationFrame( tick, main[0] );
      
      var startTime = new Date;
    }
    
    function debug( msg ) {
      if ( console && console.log ) {
        console.log( msg );
      }
    }
    
    function info( msg ) {
      if ( console && console.log ) {
        console.log( msg );
      }
    }
    
    function loadScript( src, callback ) {
      debug( 'requesting script ' + src );
      
      var called = false;
      
      var script = document.createElement( 'script' );
      script.type = 'text/javascript';
      script.async = true;
      script.onload = script.onreadystatechange = function() {
        var state = this.readyState;
        if ( state && state != "complete" && state != "loaded" ) {
          return;
        }
        
        if ( !called ) {
          debug( 'completed script ' + src );
          called = true;
          callback();
        }
      };
      
      // make sure things aren't cached, just in case
      script.src = src + '?random=' + Math.random().toFixed( 10 );
      
      var other = document.getElementsByTagName( 'script' )[0];
      other.parentNode.insertBefore( script, other );
    }
  </script>
</body>
</html>
