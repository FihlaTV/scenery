<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Scenery Playground</title>
  
  <script src="../contrib/jquery-1.8.3.min.js"></script>
  <script src="../contrib/lodash.min-1.0.0-rc.3.js"></script>
  <script src="../contrib/has.js"></script>
  
  <script data-main="../js/config.js" src="../contrib/require-2.1.4.js"></script>
  
  <style>
    html, body {
      background-color: #eee;
      border: 0;
      padding: 0;
    }
    
    #scene {
      position: absolute;
      width: 512px;
      height: 256px;
      background-color: #fff;
    }
    
    #debug {
      position: relative;
      top: 256px;
    }
    
    #serialized {
      position: relative;
      top: 256px;
      padding: 15px;
      border: 1px solid gray;
    }
  </style>
  
</head>
<body>
  
  <div id="scene"></div>
  
  <div id="debug"></div>
  
  <pre id="serialized"></pre>
  
  <script>
    var basicSceneStep = true;
    var fuzzStep = false;
    
    // we need to wait until our config file is loaded before our require statement. apparently this was not guaranteed
    function check() {
      if ( window.loadedSceneryConfig ) {
        requirejs( [ 'main', 'KITE/main', 'DOT/main', 'PHET_CORE/main' ], function( scenery, kite, dot, core ) {
          window.scenery = scenery;
          window.kite = kite;
          window.dot = dot;
          window.core = core;
          
          console.log( 'loaded' );
          
          window.scene = new scenery.Scene( $( '#scene' ) );
          console.log( 'window.scene created' );
          
          window.shape = kite.Shape.rectangle( 0, 0, 50, 40 );
          
          core.loadScript( {
            src: 'qunit/js/test-utils.js',
            callback: function() {
              console.log( 'loaded test-utils.js' );
            }
          } );
          
          scenery.Util.polyfillRequestAnimationFrame();
          
          (function step(){
            if ( basicSceneStep ) {
              window.requestAnimationFrame( step, document.getElementById( 'scene' ) );
            }
            
            $( '#debug' ).html( scene.getDebugHTML() );
            
            $( '#serialized' ).html( scene.toStringWithChildren() );
          })();
          
          window.twrap = function( f ) {
            try {
              f();
            } catch( e ) {
              console.log( e.stack );
            }
          };
          
          window.runError = function() {
            window.path1 = new scenery.Path( { shape: shape, fill: '#f00' } );
            window.path2 = new scenery.Path( { shape: shape, fill: '#0f0', y: 70 } );
            window.path3 = new scenery.Path( { shape: shape, fill: '#00f', x: 70, y: 140 } );
            
            window.node = new scenery.Node();
            
            scene.addChild( path1 );
            scene.addChild( path2 );
            path1.addChild( path3 );
            
            // scene.addChild( path3 );
            
            // scene.addChild( node );
            // scene.updateScene();
            // scene.removeChild( node );
            // scene.addChild( path1 );
            // scene.addChild( path2 );
            // scene.addChild( path3 ); // should be canvas, but right now is SVG!
            
            // scene.updateScene();
          };
          
          window.fuzzLayers = function() {
            // disable the regular step
            basicSceneStep = false;
            fuzzStep = true;
            
            var nodes = [];
            var scene = new scenery.Scene( $( '<div>' ), { width: 640, height: 480 } );
            nodes.push( scene );
            
            _.times( 5, function() { nodes.push( new scenery.Node() ); } );
            _.times( 10, function() { nodes.push( new scenery.Path() ); } );
            // _.times( 5, function() { nodes.push( new scenery.DOM( document.createElement( 'div' ) ) ); } );
            
            (function fuzz(){
              // abort if desired
              if ( !fuzzStep ) {
                return;
              }
              
              var nodeMutators = [
                { weight: 1.0, f: function( node ) { node.renderer = 'canvas'; }, mess: 'canvas renderer' },
                { weight: 1.0, f: function( node ) { node.renderer = 'svg'; }, mess: 'svg renderer' },
                { weight: 2.0, f: function( node ) { node.renderer = null; }, mess: 'null renderer' }
              ];
              
              var totalWeight = _.reduce( _.pluck( nodeMutators, 'weight' ), function( memo, num ) { return memo + num; }, 0 );
              
              _.times( 20, function() {
                window.beforeFuzzDebug = scene.getDebugHTML();
                window.beforeFuzzSerialization = scene.toStringWithChildren();
                
                var r = Math.random();
                
                // pick two different nodes at random
                var a = nodes[_.random( 0, nodes.length - 1 )];
                var b = nodes[_.random( 0, nodes.length - 1 )];
                
                if ( r < 0.333 ) {
                  // attempt to add a node to another one
                  if ( a.canAddChild( b ) ) {
                    // insert it into a random place
                    var index = _.random( 0, a.children.length );
                    window.fuzzMessage = 'inserting child ' + b.id + ' into ' + a.id + ' at index ' + index;
                    a.insertChild( index, b );
                  }
                } else if( r < 0.666 ) {
                  if ( a.children.length ) {
                    var child = a.children[_.random( 0, a.children.length - 1 )];
                    window.fuzzMessage = 'removing child ' + child.id + ' to ' + a.id;
                    a.removeChild( child );
                  }
                } else {
                  // pick a random modification from the weighted list
                  var rr = Math.random() * totalWeight;
                  for ( var i = 0; i < nodeMutators.length; i++ ) {
                    var mutator = nodeMutators[i];
                    rr -= mutator.weight;
                    if ( rr <= 0 ) {
                      window.fuzzMessage = 'mutating node ' + a.id + ' with ' + mutator.mess;
                      mutator.f( a );
                      break;
                    }
                  }
                }
                
                scene.layerAudit();
                
              } );
              $( '#debug' ).html( scene.getDebugHTML() );
              
              // an error above will prevent this from running
              window.requestAnimationFrame( fuzz );
            })();
          };
        } );
      } else {
        setTimeout( check, 4 );
      }
    }
    setTimeout( check, 4 );
  </script>
</body>
</html>
