<!DOCTYPE html>
<html>
<!--
When run in the browser, this will load code into the global namespace so that it can be tested via the developer console. Additionally, it provides
an UI and Display made for visual testing and debugging.
-->
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Scenery Playground</title>

  <script src="../../assert/js/assert.js"></script>
  <script src="../../sherpa/jquery-2.1.0.js"></script>
  <script src="../../sherpa/lodash-2.4.1.min.js"></script>
  <script src="../../sherpa/has.js"></script>

  <script type="text/javascript">
    window.assertions.enableAssert();
    window.assertions.enableAssertSlow();
  </script>

  <script data-main="../js/config.js" src="../../sherpa/require-2.1.11.js"></script>

  <style>
    html, body {
      background-color: #eee;
      border: 0;
      padding: 0;
    }

    #display {
      background-color: #fff;
    }

    #debug {
      position: relative;
      top: 320px;
      padding: 0.5em;
      border: 1px solid rgba(0, 0, 255, 0.3);
    }

    #serialized {
      position: relative;
      top: 320px;
      padding: 0.5em;
      border: 1px solid rgba(0, 0, 0, 0.3);
    }

    #controls {
      position: absolute;
      width: 170px;
      top: 0;
      right: 0;
    }
  </style>

</head>
<body>

<div id="controls">
  <button onclick="toggleDebug();">Toggle Debug</button>
  <br>
  <button onclick="toggleSerialize();">Toggle Serialization</button>
  <br>
  <button onclick="toggleLogging();">Toggle Logging</button>
  <br>
  <button onclick="display.setPointerDisplayVisible( !display._pointerOverlay );">Toggle Pointer Overlay</button>
  <br>
  <button onclick="display.setPointerAreaDisplayVisible( !display._pointerAreaOverlay );">Toggle Pointer Area Overlay</button>
  <br>
  <button onclick="toggleUpdates();">Toggle Update</button>
  <br>
  <button onclick="display.initializeStandaloneEvents();">Standalone Events</button>
  <br>
  <br>
  <button onclick="display.updateDisplay();">Update</button>
  <br>
  <button onclick="display.popupDebug();">Popup Debug</button>
  <br>
</div>

<script>
  var fuzzStep = false;

  require( [ 'config' ], function() {
    require( [ 'main', 'KITE/main', 'DOT/main', 'PHET_CORE/main' ], function( scenery, kite, dot, core ) {
      window.scenery = scenery;
      window.kite = kite;
      window.dot = dot;
      window.core = core;

      console.log( 'loaded' );

      window.scene = new scenery.Node();

      var display = window.display = new scenery.Display( scene, {
        width: 640,
        height: 320
        // any overrides here?
      } );
      console.log( 'window.display created' );

      display._domElement.id = 'display';
      document.body.insertBefore( display._domElement, document.body.firstChild );

      core.loadScript( {
        src: 'qunit/js/test-utils.js',
        callback: function() {
          console.log( 'loaded test-utils.js' );
        }
      } );

      scenery.Util.polyfillRequestAnimationFrame();

      // convenience function for IE stack trackes
      window.twrap = function( f ) {
        try {
          f();
        }
        catch( e ) {
          console.log( e.stack );
        }
      };

      window.displayTest = function() {
        setTimeout( function() {
          window.image = new scenery.Image( 'svg/wrench.svg', { mipmap: true } );
          scenery.enableIndividualLog( 'ImageSVGDrawable' );

          scene.addChild( image );

          display.updateDisplay();
        } );
      };

      window.displayErr = function() {
        setTimeout( function() {
          // var scene = new scenery.Node();
          // var display = new scenery.Display( scene, { width: 640, height: 480, backgroundColor: '#eee' } );
          display.updateDisplay();
          // document.body.appendChild( display.domElement );
          var node0 = new scenery.Node();
          var node1 = new scenery.Node();
          var node2 = new scenery.Node();
          var node3 = new scenery.Node();
          var node4 = new scenery.Node();
          var node5 = new scenery.Node();
          var node6 = new scenery.Node();
          var path0 = new scenery.Path();
          var path1 = new scenery.Path();
          var path2 = new scenery.Path();
          var path3 = new scenery.Path();
          var text0 = new scenery.Text( '0!' );
          var text1 = new scenery.Text( '1!' );
          var text2 = new scenery.Text( '2!' );
          path1.transform.setMatrix( dot.Matrix3.translation( -32.44505035690963, -98.1668230611831 ) );
          node6.transform.append( dot.Matrix3.scaling( 1.168576366151143 ) );
          path1.insertChild( 0, node4 );
          display.updateDisplay();
          node6.insertChild( 0, node1 );
          display.updateDisplay();
          node2.transform.append( dot.Matrix3.scaling( 0.9290467124659758 ) );
          node0.insertChild( 0, path2 );
          path0.transform.prepend( dot.Matrix3.rotation2( 3.792262027666663 ) );
          node2.insertChild( 0, path1 );
          scene.transform.setMatrix( dot.Matrix3.scaling( 1.0652395860519448 ) );
          node5.insertChild( 0, scene );
          display.updateDisplay();
          node0.insertChild( 0, node5 );
          scene.transform.prepend( dot.Matrix3.translation( -60.56225313805044, -54.93031018413603 ) );
          display.updateDisplay();
          path0.insertChild( 0, scene );
          display.updateDisplay();
          node4.insertChild( 0, path3 );
          node5.removeChild( scene );
          display.updateDisplay();
          path2.transform.append( dot.Matrix3.translation( 44.616689113900065, -68.61302475444973 ) );
          node1.insertChild( 0, path3 );
          path1.transform.append( dot.Matrix3.translation( -44.1397812217474, 98.97929755970836 ) );
          display.updateDisplay();
          node1.transform.append( dot.Matrix3.scaling( 1.5829629705980608 ) );
          path0.transform.prepend( dot.Matrix3.scaling( 1.5564730019536057 ) );
          node1.removeChild( path3 );
          scene.transform.append( dot.Matrix3.scaling( 1.5586118499044517 ) );
          scene.insertChild( 0, node0 );
          node0.removeChild( path2 );
          node0.renderer = "dom";
          display.updateDisplay();
          node2.transform.prepend( dot.Matrix3.translation( -61.97072793729603, -28.655776381492615 ) );
          node0.insertChild( 1, path1 );
          node2.insertChild( 0, path0 );
          path0.transform.setMatrix( dot.Matrix3.translation( -61.45704006776214, -6.235768087208271 ) );
          node3.insertChild( 0, path3 );
          node0.renderer = "canvas";
          node3.insertChild( 1, node4 );
          node3.insertChild( 0, node2 );
          node5.insertChild( 0, node1 );
          node4.transform.append( dot.Matrix3.translation( 4.2561776004731655, 50.60155764222145 ) );
          path0.insertChild( 0, path1 );
          node5.removeChild( node1 );
          node6.removeChild( node1 );
          path2.insertChild( 0, node6 );
          node6.transform.append( dot.Matrix3.scaling( 1.1971846745576897 ) );
          path3.renderer = "svg";
          path0.removeChild( path1 );
          node2.removeChild( path1 );
          path1.transform.append( dot.Matrix3.scaling( 1.2222473953146675 ) );
          path3.renderer = null;
          node1.transform.setMatrix( dot.Matrix3.translation( -0.7876493502408266, 63.92685920000076 ) );
          display.updateDisplay();
        } );
      };

      window.cssTest = function() {
        window.assertSlow = window.assert;
        setTimeout( function() {
          window.back = new scenery.Rectangle( 0, 0, 100, 100, 0, 0, {
            fill: '#000'
          } );
          window.rect = new scenery.Rectangle( 0, 0, 100, 50, 0, 0, {
            y: 50,
            fill: new scenery.LinearGradient( 0, 0, 100, 0 ).addColorStop( 0, 'red' ).addColorStop( 1, 'blue' )
          } );
          window.a = new scenery.Node( {} );
          window.b = new scenery.Node( { y: 100 } );
          b._hints.cssTransform = true;
          // window.node.rendererOptions = { cssTransform: true };
          a.addChild( back );
          a.addChild( rect );
          b.addChild( back );
          b.addChild( rect );
          scene.addChild( a );
          scene.addChild( b );

          display.updateDisplay();

          scene.renderer = 'canvas';

          display.updateDisplay();
        } );
      };

      window.transformTest = function() {
        window.n = new scenery.Node();
        n.addChild( new scenery.Rectangle( 0, 50, 100, 50, { fill: '#aaa' } ) );
        n.addChild( new scenery.Rectangle( 50, 0, 50, 50, { fill: '#aaf' } ) );
        scene.addChild( n );
        n.x = 50;
        n.y = 50;
        n.rotation = Math.PI / 4;
        n.left = 50;
        scene.addChild( scenery.Rectangle.bounds( n.bounds, { stroke: 'red' } ) );
        n.transformBounds = true;
        scene.addChild( scenery.Rectangle.bounds( n.bounds, { stroke: 'blue' } ) );

        display.updateDisplay();
      };

      /*---------------------------------------------------------------------------*
       * Debug
       *----------------------------------------------------------------------------*/

      var playgroundDebugging = false;
      var playgroundDebuggingRequestID = 0;

      var debug = document.createElement( 'div' );
      debug.id = 'debug';
      debug.style.display = 'none';
      document.body.appendChild( debug );

      function debugStep() {
        playgroundDebuggingRequestID = window.requestAnimationFrame( debugStep, debug );

        debug.style.display = '';
        debug.innerHTML = display.getDebugHTML();
      }

      window.toggleDebug = function() {
        if ( playgroundDebugging ) {
          window.cancelAnimationFrame( playgroundDebuggingRequestID );
          debug.style.display = 'none';
        }
        else {
          debugStep();
        }

        playgroundDebugging = !playgroundDebugging;
      };

      /*---------------------------------------------------------------------------*
       * Serialization
       *----------------------------------------------------------------------------*/

      var playgroundSerializing = false;
      var playgroundSerializingRequestID = 0;

      var serialized = document.createElement( 'pre' );
      serialized.id = 'serialized';
      serialized.style.display = 'none';
      document.body.appendChild( serialized );

      function serializeStep() {
        playgroundSerializingRequestID = window.requestAnimationFrame( serializeStep, serialized );

        serialized.style.display = '';
        serialized.innerHTML = display.toStringWithChildren( true, 'scene' );
      }

      window.toggleSerialize = function() {
        if ( playgroundSerializing ) {
          window.cancelAnimationFrame( playgroundSerializingRequestID );
          serialized.style.display = 'none';
        }
        else {
          serializeStep();
        }

        playgroundSerializing = !playgroundSerializing;
      };

      /*---------------------------------------------------------------------------*
       * Updates
       *----------------------------------------------------------------------------*/

      var playgroundUpdating = false;

      window.toggleUpdates = function() {
        if ( playgroundUpdating ) {
          display.cancelUpdateOnRequestAnimationFrame();
        }
        else {
          display.updateOnRequestAnimationFrame();
        }

        playgroundUpdating = !playgroundUpdating;
      };

      /*---------------------------------------------------------------------------*
       * Logging
       *----------------------------------------------------------------------------*/

      var logging = false;

      window.toggleLogging = function() {
        if ( logging ) {
          scenery.disableLogging();
          // scenery.disableEventLogging();
        }
        else {
          scenery.enableLogging( [
            'stitch',
            'perf'
          ] );
          // scenery.enableEventLogging();
        }

        logging = !logging;
      };
    } );
  } );
</script>
</body>
</html>
