<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Scenery Playground</title>
  
  <script src="../../sherpa/jquery-2.1.0.js"></script>
  <script src="../../sherpa/lodash-2.4.1.min.js"></script>
  <script src="../../sherpa/has.js"></script>
  
  <script data-main="../js/config.js" src="../../sherpa/require-2.1.11.js"></script>
  
  <style>
    html, body {
      background-color: #eee;
      border: 0;
      padding: 0;
    }
    
    #display {
      background-color: #fff;
    }
    
    #debug {
      position: relative;
      top: 320px;
      padding: 0.5em;
      border: 1px solid rgba(0,0,255,0.3);
    }
    
    #serialized {
      position: relative;
      top: 320px;
      padding: 0.5em;
      border: 1px solid rgba(0,0,0,0.3);
    }
    
    #controls {
      position: absolute;
      width: 150px;
      top: 0;
      right: 0;
    }
  </style>
  
</head>
<body>
  
  <div id="controls">
    <button onclick="toggleDebug();">Toggle Debug</button>
    <button onclick="toggleSerialize();">Toggle Serialization</button>
    <button onclick="toggleUpdates();">Toggle Update</button>
    <button onclick="toggleLogging();">Toggle Logging</button>
    <button onclick="display.initializeStandaloneEvents();">Standalone Events</button>
    <br>
    <br>
    <button onclick="display.updateDisplay();">Update</button>
    <button onclick="display.popupDebug();">Popup Debug</button>
  </div>
  
  <script>
    var fuzzStep = false;
    
    // we need to wait until our config file is loaded before our require statement. apparently this was not guaranteed
    function check() {
      if ( window.loadedSceneryConfig ) {
        requirejs( [ 'main', 'KITE/main', 'DOT/main', 'PHET_CORE/main' ], function( scenery, kite, dot, core ) {
          window.scenery = scenery;
          window.kite = kite;
          window.dot = dot;
          window.core = core;
          
          console.log( 'loaded' );
          
          window.scene = new scenery.Node();
          
          var display = window.display = new scenery.Display( scene, {
            width: 640,
            height: 320
            // any overrides here?
          } );
          console.log( 'window.display created' );
          
          display._domElement.id = 'display';
          document.body.insertBefore( display._domElement, document.body.firstChild );
          
          core.loadScript( {
            src: 'qunit/js/test-utils.js',
            callback: function() {
              console.log( 'loaded test-utils.js' );
            }
          } );
          
          scenery.Util.polyfillRequestAnimationFrame();
          
          // convenience function for IE stack trackes
          window.twrap = function( f ) {
            try {
              f();
            } catch( e ) {
              console.log( e.stack );
            }
          };
          
          window.displayTest = function() {
            setTimeout( function(){
              window.node = new scenery.Node( { x: 10 } );
              // window.node.rendererOptions = { cssTransform: true };
              window.rect = new scenery.Rectangle( 0, 0, 100, 50, 0, 0, {
                fill: new scenery.LinearGradient( 0, 0, 100, 0 ).addColorStop( 0, 'red' ).addColorStop( 1, 'blue' )
              } );
              node.addChild( rect );
              scene.addChild( node );
              
              window.circle = new scenery.Circle( 50, { fill: 'black', x: 30, y: 60 } );
              node.addChild( circle );
              
              node.centerX = display.width / 2;
              node.centerY = display.height / 2;
              
              circle.addInputListener( new scenery.SimpleDragHandler( {
                translate: function( data ) {
                  circle.translate( data.delta );
                }
              } ) );
              circle.cursor = 'pointer';
              
              display.updateDisplay();
            } );
          };
          
          window.cssTest = function() {
            window.assertSlow = window.assert;
            setTimeout( function(){
              window.back = new scenery.Rectangle( 0, 0, 100, 100, 0, 0, {
                fill: '#000'
              } );
              window.rect = new scenery.Rectangle( 0, 0, 100, 50, 0, 0, {
                y: 50,
                fill: new scenery.LinearGradient( 0, 0, 100, 0 ).addColorStop( 0, 'red' ).addColorStop( 1, 'blue' )
              } );
              window.a = new scenery.Node( {} );
              window.b = new scenery.Node( { y: 100 } );
              b._hints.cssTransform = true;
              // window.node.rendererOptions = { cssTransform: true };
              a.addChild( back );
              a.addChild( rect );
              b.addChild( back );
              b.addChild( rect );
              scene.addChild( a );
              scene.addChild( b );
              
              display.updateDisplay();
              
              scene.renderer = 'canvas';
              
              display.updateDisplay();
            } );
          };
          
          /*---------------------------------------------------------------------------*
          * Debug
          *----------------------------------------------------------------------------*/
          
          var playgroundDebugging = false;
          var playgroundDebuggingRequestID = 0;
          
          var debug = document.createElement( 'div' );
          debug.id = 'debug';
          debug.style.display = 'none';
          document.body.appendChild( debug );
          
          function debugStep() {
            playgroundDebuggingRequestID = window.requestAnimationFrame( debugStep, debug );
            
            debug.style.display = '';
            debug.innerHTML = display.getDebugHTML();
          }
          
          window.toggleDebug = function() {
            if ( playgroundDebugging ) {
              window.cancelAnimationFrame( playgroundDebuggingRequestID );
              debug.style.display = 'none';
            } else {
              debugStep();
            }
            
            playgroundDebugging = !playgroundDebugging;
          };
          
          /*---------------------------------------------------------------------------*
          * Serialization
          *----------------------------------------------------------------------------*/
          
          var playgroundSerializing = false;
          var playgroundSerializingRequestID = 0;
          
          var serialized = document.createElement( 'pre' );
          serialized.id = 'serialized';
          serialized.style.display = 'none';
          document.body.appendChild( serialized );
          
          function serializeStep() {
            playgroundSerializingRequestID = window.requestAnimationFrame( serializeStep, serialized );
            
            serialized.style.display = '';
            serialized.innerHTML = display.toStringWithChildren( true, 'scene' );
          }
          
          window.toggleSerialize = function() {
            if ( playgroundSerializing ) {
              window.cancelAnimationFrame( playgroundSerializingRequestID );
              serialized.style.display = 'none';
            } else {
              serializeStep();
            }
            
            playgroundSerializing = !playgroundSerializing;
          };
          
          /*---------------------------------------------------------------------------*
          * Updates
          *----------------------------------------------------------------------------*/
          
          var playgroundUpdating = false;
          
          window.toggleUpdates = function() {
            if ( playgroundUpdating ) {
              display.cancelUpdateOnRequestAnimationFrame();
            } else {
              display.updateOnRequestAnimationFrame();
            }
            
            playgroundUpdating = !playgroundUpdating;
          };
          
          /*---------------------------------------------------------------------------*
          * Logging
          *----------------------------------------------------------------------------*/
          
          var logging = false;
          
          window.toggleLogging = function() {
            if ( logging ) {
              scenery.disableLayerLogging();
              // scenery.disableEventLogging();
            } else {
              scenery.enableLayerLogging();
              // scenery.enableEventLogging();
            }
            
            logging = !logging;
          };
          
          /*---------------------------------------------------------------------------*
          * Miscellaneous
          *----------------------------------------------------------------------------*/
          
          // window.fuzzLayers = function() {
          //   // disable the regular step
          //   basicSceneStep = false;
          //   fuzzStep = true;
            
          //   // disable the layer logging, or we'll spam ourselves to death
          //   scenery.disableLayerLogging();
          //   scenery.disableEventLogging();
            
          //   var lines = [];
          //   window.lines = lines;
            
          //   var nodes = [];
          //   var scene = new scenery.Scene( $( '<div>' ), { width: 640, height: 320 } );
          //   nodes.push( scene );
            
          //   _.times( 5, function() { nodes.push( new scenery.Node() ); } );
          //   _.times( 10, function() { nodes.push( new scenery.Path() ); } );
          //   // _.times( 5, function() { nodes.push( new scenery.DOM( document.createElement( 'div' ) ) ); } );
            
          //   function name( node ) {
          //     return node === scene ? 'scene' : node.constructor.name.toLowerCase() + node.id;
          //   }
            
          //   _.each( nodes, function( node ) {
          //     if ( node !== scene ) {
          //       lines.push( 'var ' + name( node ) + ' = ' + node.toString() + ';' );
          //     }
          //   } );
            
          //   (function fuzz(){
          //     // abort if desired
          //     if ( !fuzzStep ) {
          //       return;
          //     }
              
          //     var nodeMutators = [
          //       {
          //         weight: 1.0,
          //         f: function( node ) { node.renderer = 'canvas'; },
          //         mess: 'canvas renderer',
          //         line: function( node ) { return name( node ) + '.renderer = \'canvas\';' }
          //       },
          //       {
          //         weight: 1.0,
          //         f: function( node ) { node.renderer = 'svg'; },
          //         mess: 'svg renderer',
          //         line: function( node ) { return name( node ) + '.renderer = \'svg\';' }
          //       },
          //       {
          //         weight: 2.0,
          //         f: function( node ) { node.renderer = null; },
          //         mess: 'null renderer',
          //         line: function( node ) { return name( node ) + '.renderer = null;' }
          //       },
          //       {
          //         weight: 0.3,
          //         f: function( node ) { node.layerSplit = true; },
          //         mess: 'layerSplit true',
          //         line: function( node ) { return name( node ) + '.layerSplit = true;' }
          //       },
          //       {
          //         weight: 1.0,
          //         f: function( node ) { node.layerSplit = false; },
          //         mess: 'layerSplit false',
          //         line: function( node ) { return name( node ) + '.layerSplit = false;' }
          //       }
          //     ];
              
          //     var totalWeight = _.reduce( _.pluck( nodeMutators, 'weight' ), function( memo, num ) { return memo + num; }, 0 );
              
          //     _.times( 20, function() {
          //       window.beforeFuzzDebug = scene.getDebugHTML();
          //       window.beforeFuzzSerialization = scene.toStringWithChildren( true );
                
          //       var r = Math.random();
                
          //       // pick two different nodes at random
          //       var a = nodes[_.random( 0, nodes.length - 1 )];
          //       var b = nodes[_.random( 0, nodes.length - 1 )];
                
          //       if ( r < 0.333 ) {
          //         // attempt to add a node to another one
          //         if ( a.canAddChild( b ) ) {
          //           // insert it into a random place
          //           var index = _.random( 0, a.children.length );
          //           window.fuzzMessage = 'inserting child ' + b.id + ' into ' + a.id + ' at index ' + index;
          //           lines.push( name( a ) + '.insertChild( ' + index + ', ' + name( b ) + ' );' );
          //           a.insertChild( index, b );
          //         }
          //       } else if( r < 0.666 ) {
          //         if ( a.children.length ) {
          //           var child = a.children[_.random( 0, a.children.length - 1 )];
          //           window.fuzzMessage = 'removing child ' + child.id + ' to ' + a.id;
          //           lines.push( name( a ) + '.removeChild( ' + name( child ) + ' );' );
          //           a.removeChild( child );
          //         }
          //       } else {
          //         // pick a random modification from the weighted list
          //         var rr = Math.random() * totalWeight;
          //         for ( var i = 0; i < nodeMutators.length; i++ ) {
          //           var mutator = nodeMutators[i];
          //           rr -= mutator.weight;
          //           if ( rr <= 0 ) {
          //             window.fuzzMessage = 'mutating node ' + a.id + ' with ' + mutator.mess;
          //             lines.push( mutator.line( a ) );
          //             mutator.f( a );
          //             break;
          //           }
          //         }
          //       }
                
          //       scene.layerAudit();
                
          //     } );
          //     $( '#debug' ).html( scene.getDebugHTML() );
              
          //     // an error above will prevent this from running
          //     window.requestAnimationFrame( fuzz );
          //   })();
          // };
        } );
      } else {
        setTimeout( check, 4 );
      }
    }
    setTimeout( check, 4 );
  </script>
</body>
</html>
