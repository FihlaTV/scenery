<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="phet-sim-level" content="production">
  <title>Simulation Test WebGL</title>

  <!-- jQuery and LoDash are dependencies -->
  <script src="../../../assert/js/assert.js"></script>
  <script src="../../../sherpa/jquery-2.1.0.min.js"></script>
  <script src="../../../sherpa/lodash-2.4.1.min.js"></script>
  <script src="../../../sherpa/has.js"></script>
  <script src="../../../sherpa/stats-r12.js"></script>

  <!-- Parse query parameters, so we can easily subset the tests.-->
  <script src="../../../phetcommon/js/util/query-parameters.js"></script>

  <script type="text/javascript">
    window.assertions.enableAssert();
  </script>

  <!-- Our code, in either the concatenated 'with comments' version or the minified version -->
  <script data-main="../../js/config.js" src="../../../sherpa/require-2.1.11.js"></script>

</head>

<body>
<canvas id="canvas" style="position: absolute;top:0px; left:0px"></canvas>
<button id="add-rectangle" style="position: absolute;top:100px; left:0px">Add Rectangle</button>

<script>

  document.onready = function() {
    require( ["../js/display/webgl/WebGLRenderer"], function( WebGLRenderer ) {
      var webGLRenderer = new WebGLRenderer();

      var rectangles = [];
      var stars = [];

      var addRectangle = function() {
        var x = (Math.random() * 2 - 1) * 0.9;
        var y = (Math.random() * 2 - 1) * 0.9;
        rectangles.push( webGLRenderer.triangleSystem.createRectangle( x, y, 0.02, 0.02, x, y, 1, 1 ) );
      };

      var addStar = function() {
        var x = (Math.random() * 2 - 1) * 0.9;
        var y = (Math.random() * 2 - 1) * 0.9;
        var scale = Math.random() * 0.2;
        var star = webGLRenderer.triangleSystem.createStar( x, y, 0.15 * scale, 0.4 * scale, Math.PI + Math.random() * Math.PI * 2, Math.random(), Math.random(), Math.random(), 1 );
        stars.push( star );
      };

      webGLRenderer.events.on( 'step', function() {

        // Show one oscillation per second so it is easy to count time
        var x = 0.2 * Math.cos( Date.now() / 1000 * 2 * Math.PI );
        for ( var i = 0; i < rectangles.length; i++ ) {
          var rectangle = rectangles[i];
          rectangle.setXWidth( rectangle.initialState.x + x, rectangle.initialState.width );
        }

        for ( var mm = 0; mm < stars.length / 2; mm++ ) {
          var star = stars[mm];
          star.setStar( star.initialState._x, star.initialState._y, star.initialState._innerRadius, star.initialState._outerRadius, star.initialState._totalAngle + Date.now() / 1000 );
        }
      } );
      webGLRenderer.start();

      document.getElementById( 'add-rectangle' ).onclick = function() {
        for ( var i = 0; i < 1; i++ ) {
          addRectangle();
        }

        // When the number of vertices changes, rebind the buffer.
        webGLRenderer.bindVertexBuffer();
        webGLRenderer.bindColorBuffer();
      };

      var numRectangles = 500;
      for ( var i = 0; i < numRectangles; i++ ) {
        addRectangle();
      }

      var numStars = 500;
      for ( var k = 0; k < numStars; k++ ) {
        addStar();
      }

      webGLRenderer.bindVertexBuffer();
      webGLRenderer.bindColorBuffer();
    } );
  };

</script>

</body>
</html>
